{
    "meta": {
        "schema_version": "1.1.0",
        "awf_version": "4.0.2"
    },
    "project": {
        "name": "SmartOps AI",
        "type": "Monorepo (Web, API, Mobile)",
        "status": "MVP Stabilized — All Audit Fixes Done"
    },
    "tech_stack": {
        "frontend": {
            "framework": "Next.js 14",
            "language": "TypeScript",
            "styling": "TailwindCSS, PostCSS",
            "state": "Zustand"
        },
        "backend": {
            "framework": "NestJS 10",
            "language": "TypeScript",
            "packages": [
                "@nestjs/throttler",
                "@nestjs/event-emitter",
                "@nestjs/jwt",
                "@nestjs/passport",
                "bcrypt",
                "passport-jwt",
                "class-validator",
                "class-transformer"
            ]
        },
        "database": {
            "framework": "Prisma",
            "type": "PostgreSQL"
        },
        "mobile": {
            "framework": "Expo 51 / React Native 0.74",
            "packages": [
                "@react-native-async-storage/async-storage",
                "uuid"
            ]
        },
        "testing": {
            "framework": "Jest (SWC transform), Playwright"
        }
    },
    "database_schema": {
        "summary": "Quản lý người dùng, đơn hàng vận chuyển, cấu hình webhook, và offline queue",
        "tables": [
            {
                "name": "users",
                "description": "Lưu thông tin người dùng (hiện tại in-memory, sẽ chuyển Prisma)"
            },
            {
                "name": "offline_queue",
                "description": "Queue thao tác offline, persist bằng AsyncStorage trên Mobile"
            },
            {
                "name": "webhooks",
                "description": "Cấu hình webhook Zalo OA với xác thực HMAC SHA-256"
            }
        ],
        "relationships_explained": "Một user có nhiều đơn hàng. Offline queue gắn UUID cho mỗi item. Webhook được verify bằng HMAC trước khi xử lý."
    },
    "api_endpoints": [
        {
            "path": "POST /auth/login",
            "explained": "Đăng nhập bằng email + password, trả về JWT token. Password hash bcrypt 10 rounds."
        },
        {
            "path": "POST /orders/create",
            "explained": "Tạo đơn hàng mới (yêu cầu JWT Auth). Tự tính giá: BASE_PRICE_PER_BAG (15k) × multiplier × số túi."
        },
        {
            "path": "POST /orders/webhook/omnichannel",
            "explained": "Nhận webhook từ Zalo OA. Verify HMAC signature trước, rồi emit event qua EventEmitter."
        },
        {
            "path": "GET /orders/sse",
            "explained": "Server-Sent Events stream cho real-time notifications (order created, webhook received)."
        }
    ],
    "business_rules": [
        "Giá = BASE_PRICE_PER_BAG (15,000₫) × multiplier (x3 hoặc x5) × totalBags",
        "Thể tích ước tính = totalBags × VOLUME_PER_BAG (1.5 m³)",
        "UUID v4 cho tất cả ID generation (không dùng Math.random)",
        "Offline queue persist AsyncStorage, sync khi có mạng",
        "Webhook verify HMAC SHA-256 signature trước khi xử lý",
        "Rate limiting: 100 requests/phút (ThrottlerGuard global)"
    ],
    "features": [
        "Omnichannel Inbox (Zalo + Messenger)",
        "Smart Sync (Offline/Online with AsyncStorage)",
        "Webhook HMAC Verification",
        "Rate Limiting (ThrottlerGuard)",
        "JWT Authentication (bcrypt)",
        "Server-Sent Events (Real-time)",
        "Barcode Scanner (Mobile)",
        "Global Exception Filter"
    ],
    "architecture": {
        "web_components": [
            "OmnichannelInbox → SessionList + ChatArea + MessageInput",
            "useChatStore (Zustand)"
        ],
        "api_modules": [
            "AuthModule (login, JWT strategy, guards)",
            "OrdersModule (CRUD, webhook, SSE)"
        ],
        "mobile_screens": [
            "ShipperWorkspace → BarcodeScanner + useOfflineQueue"
        ]
    },
    "knowledge_items": {
        "patterns": [
            "UUID for ID Generation (crypto.randomUUID + uuid v4)",
            "HMAC SHA-256 Signature Verification",
            "NestJS ThrottlerGuard Global",
            "Prisma @@index optimization for high-cardinality filters",
            "EventEmitter2 for decoupled SSE streaming",
            "WebhookPayload DTO for typed webhook handling",
            "AuthenticatedRequest interface extends Express.Request",
            "Component decomposition (SessionList, ChatArea, MessageInput)"
        ],
        "gotchas": [
            "Windows NVM: PowerShell may inject Node 14 from global PATH. Must use nvm use 20 explicitly.",
            "Next.js 14 requires Node >= 18.17.0",
            "Jest on Windows PowerShell: Wrap with cmd /c and use --forceExit to avoid 'Terminate batch job' prompt",
            "autoprefixer must be installed separately in smartops-web for PostCSS to work"
        ],
        "conventions": [
            "Mọi API changes phải chạy /audit",
            "TypeScript strict: No any types — use interfaces/DTOs",
            "Magic numbers must be named constants with JSDoc",
            "Components > 80 lines should be decomposed"
        ]
    }
}